<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calcolatore Superficie Commerciale e Valore - Giuliato&Battistin</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            /* Palette from "Data-Driven Clarity" Style Guide */
            --primary-color: #6366F1; /* Indigo 500 */
            --background-body: #F7F8FA; /* */
            --background-card: #FFFFFF; /* */
            --text-primary: #1F2937; /* */
            --text-secondary: #6B7280; /* */
            --color-decline: #D1D5DB; /* */
            --color-accent: #EC4899; /* */
            --color-success: #22C55E;

            /* Typography */
            --font-family: 'Inter', sans-serif; /* */
            --fs-header: 24px; /* */
            --fs-section-title: 16px; /* */
            --fs-body: 14px; /* */
            --fs-small: 12px; /* */

            /* Spacing (8px grid) */
            --space-1: 8px;
            --space-2: 16px;
            --space-3: 24px;
            --space-4: 32px;

            /* Border Radius */
            --radius-card: 16px;
            --radius-btn: 8px;
            --radius-pill: 9999px;

            /* Shadows */
            --shadow-card: 0px 4px 6px -1px rgba(0, 0, 0, 0.05), 0px 2px 4px -1px rgba(0, 0, 0, 0.04); /* */
            --shadow-focus: 0 0 0 3px rgba(99, 102, 241, 0.3);
        }

        body {
            font-family: var(--font-family);
            line-height: 1.6;
            margin: 0;
            padding: var(--space-4);
            background-color: var(--background-body);
            color: var(--text-secondary);
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
        }
        .header {
            text-align: center;
            margin-bottom: var(--space-4);
        }
        .header h1 {
            font-size: var(--fs-header);
            font-weight: 700;
            color: var(--text-primary);
            margin: 0;
        }
         .header h2 {
             font-size: var(--fs-section-title);
             color: var(--text-secondary);
             margin-top: 4px;
             margin-bottom: var(--space-2);
             font-weight: 500;
         }
         .header .contact-info {
            font-size: var(--fs-small);
            color: var(--text-secondary);
            line-height: 1.8;
         }
          .header .contact-info a {
             color: var(--primary-color);
             text-decoration: none;
             font-weight: 500;
          }
          .header .contact-info a:hover {
             text-decoration: underline;
          }
         .header .contact-info i {
             margin-right: var(--space-1);
             color: var(--text-secondary);
         }

        h2.section-title {
            font-size: var(--fs-header);
            font-weight: 700;
            color: var(--text-primary); /* */
            text-align: center;
            margin-bottom: var(--space-4);
        }

        #calculator-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: var(--space-3); /* */
        }
        .form-section {
            background-color: var(--background-card); /* */
            padding: var(--space-3); /* */
            border-radius: var(--radius-card); /* */
            box-shadow: var(--shadow-card); /* */
            border: none; /* */
        }
        .form-section h3 {
            margin-top: 0;
            margin-bottom: var(--space-3);
            color: var(--text-primary);
            font-size: var(--fs-section-title); /* */
            font-weight: 600; /* */
        }
        label {
            display: block;
            margin-bottom: var(--space-1);
            font-weight: 500; /* */
            color: var(--text-primary);
            font-size: var(--fs-body); /* */
        }
        input[type="number"] {
            width: 100%;
            padding: 12px;
            margin-bottom: 4px;
            border: 1px solid var(--color-decline);
            border-radius: var(--radius-btn); /* */
            font-size: var(--fs-body);
            box-sizing: border-box;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
            background-color: #FBFBFC;
        }
         input[type="number"]:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: var(--shadow-focus);
        }
        .input-hint {
            font-size: var(--fs-small);
            color: var(--text-secondary);
            margin-bottom: var(--space-2);
            display: block;
        }
        button {
            color: white;
            padding: 12px 20px;
            border: 1px solid transparent;
            border-radius: var(--radius-btn); /* */
            cursor: pointer;
            font-size: var(--fs-body); /* */
            font-weight: 600; /* */
            transition: background-color 0.3s ease, transform 0.1s ease, border-color 0.3s ease, color 0.3s ease;
            width: 100%;
             display: flex;
             align-items: center;
             justify-content: center;
             gap: var(--space-1);
        }
        button:hover {
            transform: translateY(-1px);
        }
         button:active {
             transform: translateY(0px);
         }
        #calculate-btn {
            grid-column: 1 / -1;
            background-color: var(--primary-color); /* */
            padding: 14px 20px;
            font-size: 16px;
        }
         #calculate-btn:hover {
            background-color: #4F46E5;
        }
        
         .action-buttons-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: var(--space-2);
            margin-top: var(--space-4);
            border-top: 1px solid var(--color-decline);
            padding-top: var(--space-3);
         }
        #download-pdf-btn-it,
        #download-pdf-btn-en {
             background-color: transparent;
             color: var(--primary-color);
             border-color: var(--primary-color); /* */
        }
        #download-pdf-btn-it:hover,
        #download-pdf-btn-en:hover {
             background-color: rgba(99, 102, 241, 0.1);
        }
        
        #whatsapp-consultation-btn {
            background-color: var(--color-success);
            line-height: 1.2;
            padding: 12px;
            text-align: center;
        }
        #whatsapp-consultation-btn:hover {
            background-color: #16A34A;
        }
        #whatsapp-consultation-btn span {
             display: block;
             font-size: var(--fs-small);
             font-weight: 400;
         }


        #results {
            display: none; /* Hidden until calculation */
            margin-top: var(--space-4);
            background-color: var(--background-card);
            padding: var(--space-4);
            border-radius: var(--radius-card);
            box-shadow: var(--shadow-card);
        }
        #results h2.results-title {
            margin-top: 0;
            color: var(--text-primary);
            text-align: center;
            font-size: var(--fs-header);
            font-weight: 700;
            margin-bottom: var(--space-3);
        }
        .results-summary p {
            margin: var(--space-2) 0;
            font-size: 16px;
            display: flex;
            justify-content: space-between;
            align-items: baseline;
        }
        .results-summary p .label {
            color: var(--text-secondary);
        }
        .results-summary p .value {
            font-weight: 600;
            color: var(--text-primary);
        }
        .results-summary p.final-value-row .label,
        .results-summary p.final-value-row .value {
            font-size: 18px;
            font-weight: 700;
            color: var(--primary-color);
        }
        
        .results-details {
            margin-top: var(--space-4);
            font-size: var(--fs-body);
            color: var(--text-secondary);
            border-top: 1px solid var(--color-decline);
            padding-top: var(--space-3);
        }
         .results-details h4 {
             color: var(--text-primary);
             font-weight: 600;
             margin-bottom: var(--space-2);
             font-size: var(--fs-section-title);
             display: flex;
             align-items: center;
             gap: var(--space-1);
         }
        .results-details p {
            margin: 4px 0;
            font-size: var(--fs-body);
        }
        #chart-container {
            max-width: 400px;
            margin: var(--space-3) auto 0 auto;
        }
    </style>
</head>
<body>

<div class="container">
    <header class="header">
        <h1>Giuliato&Battistin</h1>
        <h2>Agenzia Immobiliare</h2>
         <div class="contact-info">
            <i class="fas fa-map-marker-alt"></i>Corso SS. Felice e Fortunato, 29 - 36100 Vicenza<br>
            <i class="fas fa-phone"></i><a href="tel:+390444525447">+39 0444 525447</a> | 
            <i class="fas fa-envelope"></i><a href="mailto:info@giuliatobattistin.it">info@giuliatobattistin.it</a> | 
            <i class="fas fa-globe"></i><a href="https://www.giuliatobattistin.it" target="_blank">www.giuliatobattistin.it</a>
        </div>
    </header>

    <h2 class="section-title">Calcolatore Superficie e Valore</h2>

    <form id="calculator-form">
        <div class="form-section">
            <h3><i class="fas fa-home"></i> Superfici Principali</h3>
            <label for="main-surface">Superficie abitabile principale (mq):</label>
            <input type="number" id="main-surface" min="0" step="0.01" placeholder="Es. 100" required>
            <span class="input-hint">Inclusi muri. Altezza > 1.70m.</span>

            <label for="mansard-surface">Mansarda abitabile (mq):</label>
            <input type="number" id="mansard-surface" min="0" step="0.01" value="0" placeholder="Es. 30">
             <span class="input-hint">Con altezza > 1.70m.</span>
        </div>

        <div class="form-section">
            <h3><i class="fas fa-sun"></i> Spazi Esterni</h3>
             <label for="balcony-uncovered">Balconi/Terrazze SCOPERTE (mq):</label>
            <input type="number" id="balcony-uncovered" min="0" step="0.01" value="0" placeholder="Es. 15">

             <label for="balcony-covered">Logge/Balconi COPERTI (mq):</label>
            <input type="number" id="balcony-covered" min="0" step="0.01" value="0" placeholder="Es. 10">

             <label for="porch-surface">Portici (mq):</label>
            <input type="number" id="porch-surface" min="0" step="0.01" value="0" placeholder="Es. 8">

             <label for="veranda-surface">Verande (mq):</label>
            <input type="number" id="veranda-surface" min="0" step="0.01" value="0" placeholder="Es. 12">
        </div>

        <div class="form-section">
            <h3><i class="fas fa-warehouse"></i> Locali Accessori</h3>
             <label for="accessory-connected">Locali acc. collegati (mq):</label>
            <input type="number" id="accessory-connected" min="0" step="0.01" value="0" placeholder="Es. 20">
            <span class="input-hint">Taverne, lavanderie etc.</span>

             <label for="accessory-unconnected">Locali acc. non collegati (mq):</label>
            <input type="number" id="accessory-unconnected" min="0" step="0.01" value="0" placeholder="Es. 8">
             <span class="input-hint">Cantine, depositi etc.</span>
        </div>

        <div class="form-section">
             <h3><i class="fas fa-tree"></i> Giardini e Cortili</h3>
             <label for="garden-surface">Giardino/Cortile (mq):</label>
            <input type="number" id="garden-surface" min="0" step="0.01" value="0" placeholder="Es. 150">
        </div>

         <div class="form-section">
            <h3><i class="fas fa-car"></i> Garage e Posti Auto</h3>
             <label for="garage-surface">Autorimesse (mq):</label>
            <input type="number" id="garage-surface" min="0" step="0.01" value="0" placeholder="Es. 25">

             <label for="parking-covered">Posti auto COPERTI (mq):</label>
            <input type="number" id="parking-covered" min="0" step="0.01" value="0" placeholder="Es. 12">

            <label for="parking-uncovered">Posti auto SCOPERTI (mq):</label>
            <input type="number" id="parking-uncovered" min="0" step="0.01" value="0" placeholder="Es. 12">
        </div>

        <div class="form-section">
            <h3><i class="fas fa-euro-sign"></i> Valore e Vetustà</h3>
             <label for="value-per-sqm">Valore €/mq (nuovo):</label>
            <input type="number" id="value-per-sqm" min="0" step="1" placeholder="Es. 2200">

             <label for="property-age">Età immobile (anni):</label>
            <input type="number" id="property-age" min="0" step="1" value="0" placeholder="Es. 23">
            <span class="input-hint">Lasciare 0 per nuovo/ristrutturato.</span>
        </div>

        <button type="button" id="calculate-btn"><i class="fas fa-calculator"></i>Calcola</button>

    </form>

    <div id="results">
        <h2 class="results-title">Risultati del Calcolo</h2>
        <div class="results-summary">
            <p>
                <span class="label">Superficie Commerciale Totale</span>
                <span class="value" id="total-surface"></span>
            </p>
            <p>
                <span class="label">Valore Indicativo Iniziale</span>
                <span class="value" id="initial-value"></span>
            </p>
            <p>
                <span class="label">Riduzione Vetustà (<span id="age-used"></span> anni)</span>
                <span class="value" id="aging-discount"></span>
            </p>
            <p class="final-value-row">
                <strong class="label">Valore Indicativo Finale</strong>
                <strong class="value" id="final-value"></strong>
            </p>
        </div>

        <div class="results-details">
             <div id="calculation-details">
                 <h4><i class="fas fa-ruler-combined"></i> Dettaglio Calcolo Superficie</h4>
                 <div id="surface-details"></div>
             </div>
             <div id="aging-details-container" style="margin-top: 24px;">
                <h4><i class="fas fa-history"></i> Dettaglio Calcolo Vetustà</h4>
                <div id="aging-details"></div>
             </div>
        </div>

        <div class="results-details">
             <h4><i class="fas fa-chart-pie"></i> Ripartizione Superficie Commerciale</h4>
              <div id="chart-container">
                   <canvas id="surfaceChart"></canvas>
              </div>
        </div>

        <div class="action-buttons-container" id="action-buttons-container">
             <button type="button" id="download-pdf-btn-it"><i class="fas fa-file-pdf"></i>Report PDF (IT)</button>
             <button type="button" id="download-pdf-btn-en"><i class="fas fa-file-pdf"></i>Report PDF (EN)</button>
             <button type="button" id="whatsapp-consultation-btn">
                 <div>
                    <i class="fab fa-whatsapp"></i> Ti serve una consulenza gratuita?
                    <span>Invia i risultati per un parere</span>
                 </div>
             </button>
        </div>
    </div>

</div>

<script>
    // --- DOM Elements ---
    const calculateBtn = document.getElementById('calculate-btn');
    const actionButtonsContainer = document.getElementById('action-buttons-container');
    const downloadPdfBtnIt = document.getElementById('download-pdf-btn-it');
    const downloadPdfBtnEn = document.getElementById('download-pdf-btn-en');
    const whatsappBtn = document.getElementById('whatsapp-consultation-btn');
    const resultsDiv = document.getElementById('results');
    
    const inputs = {
        mainSurface: document.getElementById('main-surface'),
        mansardSurface: document.getElementById('mansard-surface'),
        balconyUncovered: document.getElementById('balcony-uncovered'),
        balconyCovered: document.getElementById('balcony-covered'),
        porchSurface: document.getElementById('porch-surface'),
        verandaSurface: document.getElementById('veranda-surface'),
        accessoryConnected: document.getElementById('accessory-connected'),
        accessoryUnconnected: document.getElementById('accessory-unconnected'),
        gardenSurface: document.getElementById('garden-surface'),
        garageSurface: document.getElementById('garage-surface'),
        parkingCovered: document.getElementById('parking-covered'),
        parkingUncovered: document.getElementById('parking-uncovered'),
        valuePerSqm: document.getElementById('value-per-sqm'),
        propertyAge: document.getElementById('property-age')
    };
    const outputs = {
        totalSurface: document.getElementById('total-surface'),
        initialValue: document.getElementById('initial-value'),
        agingDiscount: document.getElementById('aging-discount'),
        finalValue: document.getElementById('final-value'),
        ageUsed: document.getElementById('age-used'),
        surfaceDetails: document.getElementById('surface-details'),
        agingDetails: document.getElementById('aging-details'),
        chartCanvas: document.getElementById('surfaceChart')
    };

    // --- State & Constants ---
    let calculationResults = {};
    let surfaceChart = null;
    const SQM_TO_SQFT = 10.7639;
    const WHATSAPP_NUMBER = "390444525447";

    // --- Event Listeners ---
    calculateBtn.addEventListener('click', calculate);
    downloadPdfBtnIt.addEventListener('click', () => generatePdf('it'));
    downloadPdfBtnEn.addEventListener('click', () => generatePdf('en'));
    whatsappBtn.addEventListener('click', openWhatsAppConsultation);

    // --- Helper Functions ---
    const N = (value) => parseFloat(value) || 0;
    const formatCurrency = (value) => value.toLocaleString('it-IT', { style: 'currency', currency: 'EUR', minimumFractionDigits: 0, maximumFractionDigits: 0 });
    const formatNumber = (value, decimals = 2, lang = 'it-IT') => value.toLocaleString(lang, { minimumFractionDigits: decimals, maximumFractionDigits: decimals });

    // --- Core Calculation Logic (Full Original Version) ---
    function calculate() {
        calculationResults = { details: [], agingDetails: [], chartData: { labels: [], data: [] } };
        outputs.surfaceDetails.innerHTML = '';
        outputs.agingDetails.innerHTML = '';

        const vals = {
            mainSurface: N(inputs.mainSurface.value),
            mansardSurface: N(inputs.mansardSurface.value),
            balconyUncovered: N(inputs.balconyUncovered.value),
            balconyCovered: N(inputs.balconyCovered.value),
            porchSurface: N(inputs.porchSurface.value),
            verandaSurface: N(inputs.verandaSurface.value),
            accessoryConnected: N(inputs.accessoryConnected.value),
            accessoryUnconnected: N(inputs.accessoryUnconnected.value),
            gardenSurface: N(inputs.gardenSurface.value),
            garageSurface: N(inputs.garageSurface.value),
            parkingCovered: N(inputs.parkingCovered.value),
            parkingUncovered: N(inputs.parkingUncovered.value),
            valuePerSqm: N(inputs.valuePerSqm.value),
            propertyAge: parseInt(inputs.propertyAge.value) || 0
        };

        if (vals.mainSurface === 0) {
            alert("Inserire almeno la Superficie abitabile principale.");
            return;
        }
        
        let totalSurface = 0;
        let detailsHtml = '';
        let chartContributions = {
            'Principale': 0, 'Balconi/Esterni': 0, 'Accessori': 0, 'Giardino': 0, 'Garage/Posti Auto': 0
        };

        const mainUnitArea = vals.mainSurface + vals.mansardSurface;
        totalSurface += mainUnitArea;
        chartContributions['Principale'] += mainUnitArea;
        detailsHtml += `<p>Abitabile Principale: ${formatNumber(vals.mainSurface)} mq (x 1.0) = ${formatNumber(vals.mainSurface)} mq</p>`;
        calculationResults.details.push({ item: "Abitabile Principale", area: vals.mainSurface, factor: 1.0, contribution: vals.mainSurface });
        if (vals.mansardSurface > 0) {
            detailsHtml += `<p>Mansarda Abitabile: ${formatNumber(vals.mansardSurface)} mq (x 1.0) = ${formatNumber(vals.mansardSurface)} mq</p>`;
            calculationResults.details.push({ item: "Mansarda Abitabile", area: vals.mansardSurface, factor: 1.0, contribution: vals.mansardSurface });
        }

        if (vals.balconyUncovered > 0 && mainUnitArea > 0) {
            let balconyUncoveredComm = 0;
            let calcDetail = "";
            let area_1_3 = Math.min(vals.balconyUncovered, mainUnitArea * 0.25);
            balconyUncoveredComm += area_1_3 * (1/3);
            calcDetail += `[${formatNumber(area_1_3)} mq x 1/3] `;
            let remaining = vals.balconyUncovered - area_1_3;
            if (remaining > 0) {
                let area_1_4 = Math.min(remaining, mainUnitArea * 0.25);
                balconyUncoveredComm += area_1_4 * (1/4);
                calcDetail += `+ [${formatNumber(area_1_4)} mq x 1/4] `;
                remaining -= area_1_4;
            }
            if (remaining > 0) {
                let area_1_6 = Math.min(remaining, mainUnitArea * 0.50);
                balconyUncoveredComm += area_1_6 * (1/6);
                calcDetail += `+ [${formatNumber(area_1_6)} mq x 1/6] `;
                remaining -= area_1_6;
            }
            if (remaining > 0) {
                balconyUncoveredComm += remaining * (1/10);
                calcDetail += `+ [${formatNumber(remaining)} mq x 1/10] `;
            }
            detailsHtml += `<p>Balconi/Terrazze Scoperte (${formatNumber(vals.balconyUncovered)} mq): ${calcDetail} = ${formatNumber(balconyUncoveredComm)} mq</p>`;
            calculationResults.details.push({ item: "Balconi/Terrazze Scoperte", area: vals.balconyUncovered, factor: "Variabile", contribution: balconyUncoveredComm, note: calcDetail });
            totalSurface += balconyUncoveredComm;
            chartContributions['Balconi/Esterni'] += balconyUncoveredComm;
        }

        if (vals.balconyCovered > 0) {
            const contribution = vals.balconyCovered * 0.5; totalSurface += contribution; chartContributions['Balconi/Esterni'] += contribution;
            detailsHtml += `<p>Logge/Balconi Coperti: ${formatNumber(vals.balconyCovered)} mq (x 0.5) = ${formatNumber(contribution)} mq</p>`;
            calculationResults.details.push({ item: "Logge/Balconi Coperti", area: vals.balconyCovered, factor: 0.5, contribution: contribution });
        }
        if (vals.porchSurface > 0) {
            const contribution = vals.porchSurface * 0.5; totalSurface += contribution; chartContributions['Balconi/Esterni'] += contribution;
            detailsHtml += `<p>Portici: ${formatNumber(vals.porchSurface)} mq (x 0.5) = ${formatNumber(contribution)} mq</p>`;
            calculationResults.details.push({ item: "Portici", area: vals.porchSurface, factor: 0.5, contribution: contribution });
        }
        if (vals.verandaSurface > 0) {
            const contribution = vals.verandaSurface * (2/3); totalSurface += contribution; chartContributions['Balconi/Esterni'] += contribution;
            detailsHtml += `<p>Verande: ${formatNumber(vals.verandaSurface)} mq (x 2/3) = ${formatNumber(contribution)} mq</p>`;
            calculationResults.details.push({ item: "Verande", area: vals.verandaSurface, factor: 2/3, contribution: contribution });
        }
        if (vals.accessoryConnected > 0) {
            const contribution = vals.accessoryConnected * (2/3); totalSurface += contribution; chartContributions['Accessori'] += contribution;
            detailsHtml += `<p>Locali Acc. Collegati: ${formatNumber(vals.accessoryConnected)} mq (x 2/3) = ${formatNumber(contribution)} mq</p>`;
            calculationResults.details.push({ item: "Locali Acc. Collegati", area: vals.accessoryConnected, factor: 2/3, contribution: contribution });
        }
        if (vals.accessoryUnconnected > 0) {
            const contribution = vals.accessoryUnconnected * 0.5; totalSurface += contribution; chartContributions['Accessori'] += contribution;
            detailsHtml += `<p>Locali Acc. NON Collegati: ${formatNumber(vals.accessoryUnconnected)} mq (x 0.5) = ${formatNumber(contribution)} mq</p>`;
            calculationResults.details.push({ item: "Locali Acc. NON Collegati", area: vals.accessoryUnconnected, factor: 0.5, contribution: contribution });
        }
        
        if (vals.gardenSurface > 0 && mainUnitArea > 0) {
            let gardenComm = 0;
            let calcDetail = "";
            let area_1_6 = Math.min(vals.gardenSurface, mainUnitArea);
            gardenComm += area_1_6 * (1/6);
            calcDetail += `[${formatNumber(area_1_6)} mq x 1/6] `;
            let remaining = vals.gardenSurface - area_1_6;
            if (remaining > 0) {
                let area_1_10 = Math.min(remaining, mainUnitArea * 3 - mainUnitArea);
                gardenComm += area_1_10 * (1/10);
                calcDetail += `+ [${formatNumber(area_1_10)} mq x 1/10] `;
                remaining -= area_1_10;
            }
            if (remaining > 0) {
                let area_1_20 = Math.min(remaining, mainUnitArea * 5 - mainUnitArea * 3);
                gardenComm += area_1_20 * (1/20);
                calcDetail += `+ [${formatNumber(area_1_20)} mq x 1/20] `;
                remaining -= area_1_20;
            }
            if (remaining > 0) {
                gardenComm += remaining * (1/50);
                calcDetail += `+ [${formatNumber(remaining)} mq x 1/50] `;
            }
            detailsHtml += `<p>Giardino/Cortile (${formatNumber(vals.gardenSurface)} mq): ${calcDetail} = ${formatNumber(gardenComm)} mq</p>`;
            calculationResults.details.push({ item: "Giardino/Cortile", area: vals.gardenSurface, factor: "Variabile", contribution: gardenComm, note: calcDetail });
            totalSurface += gardenComm;
            chartContributions['Giardino'] += gardenComm;
        }

        if (vals.garageSurface > 0) {
            const contribution = vals.garageSurface * (2/3); totalSurface += contribution; chartContributions['Garage/Posti Auto'] += contribution;
            detailsHtml += `<p>Autorimesse: ${formatNumber(vals.garageSurface)} mq (x 2/3) = ${formatNumber(contribution)} mq</p>`;
            calculationResults.details.push({ item: "Autorimesse", area: vals.garageSurface, factor: 2/3, contribution: contribution });
        }
        if (vals.parkingCovered > 0) {
            const contribution = vals.parkingCovered * 0.5; totalSurface += contribution; chartContributions['Garage/Posti Auto'] += contribution;
            detailsHtml += `<p>Posti Auto Coperti: ${formatNumber(vals.parkingCovered)} mq (x 0.5) = ${formatNumber(contribution)} mq</p>`;
            calculationResults.details.push({ item: "Posti Auto Coperti", area: vals.parkingCovered, factor: 0.5, contribution: contribution });
        }
        if (vals.parkingUncovered > 0) {
            const contribution = vals.parkingUncovered * 0.2; totalSurface += contribution; chartContributions['Garage/Posti Auto'] += contribution;
            detailsHtml += `<p>Posti Auto Scoperti: ${formatNumber(vals.parkingUncovered)} mq (x 1/5) = ${formatNumber(contribution)} mq</p>`;
            calculationResults.details.push({ item: "Posti Auto Scoperti", area: vals.parkingUncovered, factor: 1/5, contribution: contribution });
        }

        const initialValue = totalSurface * vals.valuePerSqm;
        let finalValue = initialValue;
        let agingDiscount = 0;
        let age = vals.propertyAge;
        let agingDetailsHtml = `<p>Età inserita: ${age} anni.</p>`;
        calculationResults.age = age;
        calculationResults.initialValue = initialValue;

        if (age > 0 && initialValue > 0) {
            let currentValue = initialValue;
            const ageBrackets = [
                { years: 5, rate: 1.0 }, { years: 5, rate: 1.1 }, { years: 10, rate: 1.2 },
                { years: 10, rate: 1.3 }, { years: 15, rate: 1.4 }
            ];
            let ageCovered = 0;
            for (const bracket of ageBrackets) {
                if (age <= ageCovered) break;
                const yearsInBracket = Math.min(age - ageCovered, bracket.years);
                const discountPercent = yearsInBracket * bracket.rate;
                const discountAmount = currentValue * (discountPercent / 100);
                currentValue -= discountAmount;
                const detail = `Anni ${ageCovered + 1}-${ageCovered + yearsInBracket} (${yearsInBracket} anni @ ${formatNumber(bracket.rate, 1)}%/anno = ${formatNumber(discountPercent,1)}%): Riduzione ${formatCurrency(discountAmount)}`;
                agingDetailsHtml += `<p>${detail}</p>`;
                calculationResults.agingDetails.push(detail);
                ageCovered += yearsInBracket;
            }
            finalValue = currentValue;
            agingDiscount = initialValue - finalValue;
        } else if (age == 0) {
            const isRecentOrRenovated = confirm("L'immobile è 'recente o ristrutturato a nuovo' (es. Classe A o B)?\n\nClicca 'OK' se sì.\nClicca 'Annulla' se di classe energetica inferiore (verrà applicata una riduzione indicativa).");
            if (!isRecentOrRenovated && initialValue > 0) {
                 const reductionMin = 100 * totalSurface;
                 const reductionMax = 150 * totalSurface;
                 const reductionApplied = (reductionMin + reductionMax) / 2;
                 finalValue = Math.max(0, initialValue - reductionApplied);
                 agingDiscount = initialValue - finalValue;
                 const detail = `Adeguamento per classe energetica inferiore a B: ${formatCurrency(agingDiscount)} (indicativo tra ${formatCurrency(reductionMin)} e ${formatCurrency(reductionMax)})`;
                 agingDetailsHtml = `<p>${detail}</p>`;
                 calculationResults.agingDetails = [detail];
                 alert(`Applicato adeguamento indicativo di ${formatCurrency(agingDiscount)} per classe energetica inferiore.`);
            } else {
                 agingDetailsHtml = "<p>Nessuna riduzione per vetustà applicata (immobile nuovo/recente/alta classe energetica).</p>";
                 calculationResults.agingDetails.push("Nessuna riduzione per vetustà applicata.");
            }
        }
        
        calculationResults.totalSurface = totalSurface;
        calculationResults.agingDiscount = agingDiscount;
        calculationResults.finalValue = finalValue;
        calculationResults.inputs = vals;
        
        outputs.totalSurface.textContent = `${formatNumber(totalSurface)} mq`;
        outputs.initialValue.textContent = formatCurrency(initialValue);
        outputs.agingDiscount.textContent = `- ${formatCurrency(agingDiscount)}`;
        outputs.finalValue.textContent = formatCurrency(finalValue);
        outputs.ageUsed.textContent = age;
        outputs.surfaceDetails.innerHTML = detailsHtml;
        outputs.agingDetails.innerHTML = agingDetailsHtml;

        resultsDiv.style.display = 'block';

        Object.keys(chartContributions).forEach(key => {
            if (chartContributions[key] > 0) {
                calculationResults.chartData.labels.push(key);
                calculationResults.chartData.data.push(chartContributions[key]);
            }
        });
        updateChart();
        resultsDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
    
    // --- Chart Logic ---
    function updateChart() {
        const ctx = outputs.chartCanvas.getContext('2d');
        const chartData = {
            labels: calculationResults.chartData.labels,
            datasets: [{
                label: 'Ripartizione Superficie (mq)',
                data: calculationResults.chartData.data,
                backgroundColor: ['#6366F1', '#A5B4FC', '#EC4899', '#F472B6', '#8B5CF6'],
                borderColor: 'var(--background-card)',
                borderWidth: 2
            }]
        };

        if (surfaceChart) {
            surfaceChart.data = chartData;
            surfaceChart.update();
        } else {
            surfaceChart = new Chart(ctx, {
                type: 'doughnut',
                data: chartData,
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'top' },
                        tooltip: {
                             callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? (context.parsed / total * 100).toFixed(1) : 0;
                                    return ` ${context.label}: ${formatNumber(context.parsed)} mq (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }
    }

    // --- New WhatsApp Function ---
    function openWhatsAppConsultation() {
        if (!calculationResults.totalSurface || calculationResults.finalValue === undefined) {
            alert("Completa un calcolo prima di richiedere una consulenza.");
            return;
        }
        const surface = formatNumber(calculationResults.totalSurface, 2);
        const value = formatCurrency(calculationResults.finalValue);
        const message = `Ciao, vorrei una consulenza gratuita basata su questa stima che ho appena calcolato:\n\n- Superficie Commerciale: *${surface} mq*\n- Valore Indicativo Finale: *${value}*\n\nResto in attesa di un vostro contatto.\nGrazie.`;
        const encodedMessage = encodeURIComponent(message);
        const whatsappUrl = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodedMessage}`;
        window.open(whatsappUrl, '_blank');
    }

    // --- PDF Generation (Full Original Version with Style Updates) ---
    function generatePdf(lang = 'it') {
        if (Object.keys(calculationResults).length === 0 || !calculationResults.inputs) {
            alert(lang === 'it' ? "Effettua prima un calcolo." : "Please perform a calculation first.");
            return;
        }

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const margin = 15;
        let y = 20;
        const pageHeight = doc.internal.pageSize.getHeight();
        const pageWidth = doc.internal.pageSize.getWidth();
        const primaryColor = '#6366F1';
        const textPrimaryColor = '#1F2937';
        const textSecondaryColor = '#6B7280';

        function checkPageBreak(increment = 5) {
            if (y + increment > pageHeight - margin) {
                doc.addPage();
                y = margin;
            }
        }

        const isItalian = lang === 'it';

        // --- Header ---
        doc.setFontSize(16); doc.setFont("helvetica", "bold"); doc.setTextColor(primaryColor);
        doc.text("Giuliato&Battistin", pageWidth / 2, y, { align: 'center' });
        y += 6; doc.setFontSize(9); doc.setFont("helvetica", "normal"); doc.setTextColor(100, 100, 100);
        doc.text(isItalian ? "agenzia immobiliare" : "Real Estate Agency", pageWidth / 2, y, { align: 'center' });
        y += 4;
        doc.text("Corso SS. Felice e Fortunato, 29 - 36100 Vicenza Italy", pageWidth / 2, y, { align: 'center' });
        y += 4;
        doc.text("Tel: +39 0444 525447 | Email: info@giuliatobattistin.it | Web: www.giuliatobattistin.it", pageWidth / 2, y, { align: 'center' });
        y += 8; doc.setLineWidth(0.3); doc.setDrawColor(200, 200, 200); doc.line(margin, y, pageWidth - margin, y);
        y += 10;

        // --- Title ---
        doc.setFontSize(14); doc.setFont("helvetica", "bold"); doc.setTextColor(textPrimaryColor);
        doc.text(isItalian ? "Report Calcolo Indicativo Superficie e Valore" : "Indicative Commercial Surface Area and Value Report", margin, y);
        y += 10; checkPageBreak(10);

        // --- Input Summary ---
        doc.setFontSize(12); doc.setFont("helvetica", "bolditalic"); doc.setTextColor(textSecondaryColor);
        doc.text(isItalian ? "Dati Inseriti" : "Input Data Summary", margin, y);
        y += 6; checkPageBreak(6); doc.setFontSize(9); doc.setFont("helvetica", "normal"); doc.setTextColor(textPrimaryColor);
        
        const inputsData = calculationResults.inputs;
        const valuePerSqft = inputsData.valuePerSqm > 0 ? inputsData.valuePerSqm / SQM_TO_SQFT : 0;
        const inputItems = isItalian ? [
            { label: "Sup. Abitabile Principale:", value: inputsData.mainSurface, unit: "mq" },
            { label: "Mansarda Abitabile:", value: inputsData.mansardSurface, unit: "mq" },
            { label: "Balconi/Terrazze Scoperte:", value: inputsData.balconyUncovered, unit: "mq" },
            { label: "Logge/Balconi Coperti:", value: inputsData.balconyCovered, unit: "mq" },
            { label: "Portici:", value: inputsData.porchSurface, unit: "mq" },
            { label: "Verande:", value: inputsData.verandaSurface, unit: "mq" },
            { label: "Locali Acc. Collegati:", value: inputsData.accessoryConnected, unit: "mq" },
            { label: "Locali Acc. NON Collegati:", value: inputsData.accessoryUnconnected, unit: "mq" },
            { label: "Giardino/Cortile Esclusivo:", value: inputsData.gardenSurface, unit: "mq" },
            { label: "Autorimesse:", value: inputsData.garageSurface, unit: "mq" },
            { label: "Posti Auto Coperti:", value: inputsData.parkingCovered, unit: "mq" },
            { label: "Posti Auto Scoperti:", value: inputsData.parkingUncovered, unit: "mq" },
            { label: "Valore Base:", value: inputsData.valuePerSqm, unit: "€/mq" },
            { label: "Età Immobile:", value: inputsData.propertyAge, unit: "anni" },
        ] : [
            { label: "Main Habitable Area:", value: inputsData.mainSurface * SQM_TO_SQFT, unit: "sqft" },
            { label: "Habitable Attic:", value: inputsData.mansardSurface * SQM_TO_SQFT, unit: "sqft" },
            { label: "Uncovered Balconies/Terraces:", value: inputsData.balconyUncovered * SQM_TO_SQFT, unit: "sqft" },
            { label: "Covered Loggias/Balconies:", value: inputsData.balconyCovered * SQM_TO_SQFT, unit: "sqft" },
            { label: "Porches:", value: inputsData.porchSurface * SQM_TO_SQFT, unit: "sqft" },
            { label: "Verandas:", value: inputsData.verandaSurface * SQM_TO_SQFT, unit: "sqft" },
            { label: "Connected Ancillary Rooms:", value: inputsData.accessoryConnected * SQM_TO_SQFT, unit: "sqft" },
            { label: "Unconnected Ancillary Rooms:", value: inputsData.accessoryUnconnected * SQM_TO_SQFT, unit: "sqft" },
            { label: "Exclusive Garden/Courtyard:", value: inputsData.gardenSurface * SQM_TO_SQFT, unit: "sqft" },
            { label: "Garages:", value: inputsData.garageSurface * SQM_TO_SQFT, unit: "sqft" },
            { label: "Covered Parking Spaces:", value: inputsData.parkingCovered * SQM_TO_SQFT, unit: "sqft" },
            { label: "Uncovered Parking Spaces:", value: inputsData.parkingUncovered * SQM_TO_SQFT, unit: "sqft" },
            { label: "Base Value:", value: valuePerSqft, unit: `€/sqft (from ${formatCurrency(inputsData.valuePerSqm)}/mq)` },
            { label: "Property Age:", value: inputsData.propertyAge, unit: "years" },
        ];

        inputItems.forEach(item => {
            const rawValue = isItalian ? item.value : item.value / (item.unit === 'sqft' ? SQM_TO_SQFT : 1);
            if (rawValue > 0 || item.label.includes(isItalian ? "Età" : "Age") || item.label.includes(isItalian ? "Valore" : "Value") || item.label.includes(isItalian ? "Principale" : "Main")) {
                let valueString = formatNumber(item.value, item.unit.includes('€/sqft') ? 2 : (item.unit === 'sqft' ? 0 : 2), lang);
                doc.text(`${item.label} ${valueString} ${item.unit}`, margin + 5, y);
                y += 5; checkPageBreak(5);
            }
        });
        y += 5; checkPageBreak(5);
        
        // --- Calculation Details ---
        doc.setFontSize(12); doc.setFont("helvetica", "bolditalic"); doc.setTextColor(textSecondaryColor);
        doc.text(isItalian ? "Dettaglio Calcolo Superficie Commerciale" : "Commercial Surface Area Calculation Details", margin, y);
        y += 6; checkPageBreak(6); doc.setFontSize(9); doc.setFont("helvetica", "normal"); doc.setTextColor(textPrimaryColor);

        const itemTranslations = {
            "Abitabile Principale": "Main Habitable Area", "Mansarda Abitabile": "Habitable Attic", "Balconi/Terrazze Scoperte": "Uncovered Balconies/Terraces",
            "Logge/Balconi Coperti": "Covered Loggias/Balconies", "Portici": "Porches", "Verande": "Verandas", "Locali Acc. Collegati": "Connected Ancillary Rooms",
            "Locali Acc. NON Collegati": "Unconnected Ancillary Rooms", "Giardino/Cortile": "Garden/Courtyard", "Autorimesse": "Garages",
            "Posti Auto Coperti": "Covered Parking Spaces", "Posti Auto Scoperti": "Uncovered Parking Spaces"
        };
        
        calculationResults.details.forEach(detail => {
            const area = isItalian ? detail.area : detail.area * SQM_TO_SQFT;
            const contribution = isItalian ? detail.contribution : detail.contribution * SQM_TO_SQFT;
            const unit = isItalian ? "mq" : "sqft";
            const item = isItalian ? detail.item : (itemTranslations[detail.item] || detail.item);
            let factorText = "";
            if (typeof detail.factor === 'number') factorText = `(x ${formatNumber(detail.factor, 3, lang)})`;
            else if (detail.factor === "Variabile" && detail.note) factorText = `(${isItalian ? 'Var.' : 'Var.'}) Dettaglio: ${detail.note.replace(/mq/g, unit)}`;
            else factorText = `(${detail.factor})`;
            let line = `${item} (${formatNumber(area, 2, lang)} ${unit}) ${factorText} = ${formatNumber(contribution, 2, lang)} comm. ${unit}`;
            const splitLines = doc.splitTextToSize(line, pageWidth - margin * 2 - 5);
            doc.text(splitLines, margin + 5, y);
            y += splitLines.length * 4 + 1; checkPageBreak(splitLines.length * 4 + 1);
        });
        y += 2; checkPageBreak(2); doc.setFont("helvetica", "bold");
        const totalSurface = isItalian ? calculationResults.totalSurface : calculationResults.totalSurface * SQM_TO_SQFT;
        doc.text(`${isItalian ? 'TOTALE SUPERFICIE COMMERCIALE' : 'TOTAL COMMERCIAL SURFACE AREA'}: ${formatNumber(totalSurface, 2, lang)} ${isItalian ? 'mq' : 'sqft'}`, margin + 5, y);
        y += 10; checkPageBreak(10);

        // --- Value Calculation ---
        doc.setFontSize(12); doc.setFont("helvetica", "bolditalic"); doc.setTextColor(textSecondaryColor);
        doc.text(isItalian ? "Calcolo Valore Indicativo" : "Indicative Value Calculation", margin, y);
        y += 6; checkPageBreak(6); doc.setFontSize(9); doc.setFont("helvetica", "normal"); doc.setTextColor(textPrimaryColor);

        if (calculationResults.valuePerSqm > 0) {
            doc.text(`${isItalian ? 'Valore Iniziale' : 'Initial Value'}: ${formatNumber(totalSurface, 2, lang)} ${isItalian ? 'mq' : 'sqft'} * ${isItalian ? formatCurrency(calculationResults.valuePerSqm)+'/mq' : formatCurrency(valuePerSqft)+'/sqft'} = ${formatCurrency(calculationResults.initialValue)}`, margin + 5, y);
        } else {
            doc.text(`${isItalian ? 'Valore Iniziale: Non calcolato' : 'Initial Value: Not calculated'}`, margin + 5, y);
        }
        y += 6; checkPageBreak(6);
        doc.text(`${isItalian ? 'Età considerata per vetustà/adeguamento' : 'Age considered for aging/adjustment'}: ${calculationResults.age} ${isItalian ? 'anni' : 'years'}`, margin + 5, y);
        y += 5; checkPageBreak(5);

        if (calculationResults.agingDetails && calculationResults.agingDetails.length > 0) {
            calculationResults.agingDetails.forEach(detail => {
                let detailLang = isItalian ? detail.replace(/Sconto/g, 'Riduzione') : detail.replace(/Anni/g, 'Years').replace(/anni/g, 'years').replace(/Sconto/g, 'Discount').replace(/Riduzione/g, 'Reduction').replace(/Valore residuo/g, 'Residual Value').replace(/Adeguamento per classe energetica inferiore.*:/, 'Adjustment for lower energy class:').replace(/Nessuna riduzione per vetustà applicata/, 'No aging discount applied').replace(/Vetustà non calcolata/, 'Aging not calculated');
                const splitLines = doc.splitTextToSize(detailLang, pageWidth - margin * 2 - 10);
                doc.text(splitLines, margin + 10, y);
                y += splitLines.length * 4 + 1; checkPageBreak(splitLines.length * 4 + 1);
            });
        }
        y += 2; checkPageBreak(2);
        doc.text(`${isItalian ? 'Riduzione Totale per Vetustà/Adeguamento' : 'Total Aging/Adjustment Reduction'}: ${formatCurrency(calculationResults.agingDiscount)}`, margin + 5, y);
        y += 6; checkPageBreak(6);
        doc.setFont("helvetica", "bold");
        doc.text(`${isItalian ? 'VALORE INDICATIVO FINALE' : 'FINAL INDICATIVE VALUE'}: ${formatCurrency(calculationResults.finalValue)}`, margin + 5, y);
        y += 15; checkPageBreak(15);

        // --- Disclaimer ---
        doc.setFontSize(8); doc.setFont("helvetica", "italic"); doc.setTextColor(150, 150, 150);
        const disclaimer = isItalian ? "Nota: Questo calcolo è puramente indicativo e basato sui dati forniti dall'utente e sui criteri standard della Borsa Immobiliare di Vicenza (come interpretati in questo strumento). Va integrato con informazioni specifiche delle unità immobiliari considerate. Non costituisce una perizia di stima ufficiale. Per una valutazione precisa, contattare l'agenzia Giuliato&Battistin." : "Note: This calculation is purely indicative, based on user-provided data and standard criteria (as interpreted by this tool). It has to be integrated with specific informations about the property. It does not constitute an official appraisal. For an accurate valuation, please contact Giuliato&Battistin agency.";
        const splitDisclaimer = doc.splitTextToSize(disclaimer, pageWidth - margin * 2);
        const disclaimerY = pageHeight - margin - (splitDisclaimer.length * 3.5);
        doc.text(splitDisclaimer, margin, disclaimerY > y ? disclaimerY : y);
        
        // --- Save PDF ---
        doc.save(isItalian ? 'Report_Stima_GiuliatoBattistin_IT.pdf' : 'Report_Estimate_GiuliatoBattistin_EN.pdf');
    }

</script>

</body>
</html>
